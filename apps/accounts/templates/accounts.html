{% load static %}
<!DOCTYPE HTML>
<html>
<head>
	<title>Fortine</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="icon" type="image/ico" href="{% static 'img/favicon.ico' %}">
	
	<link rel="stylesheet" href="{% static 'css/style.css' %}" type="text/css">
	
</head>
<body class="opencase_page">
	<header class="contain">
		<div class="header_left">
			<a href="/" class="logo"><img src="{% static 'img/logo.svg' %}"> Gametrim</a>
			<a href="/" class="menu_item">Homepage</a>
			<a href="{% url 'answers' %}" class="menu_item">Question & Answer</a>
		</div>
		<div class="header_right">
			<div class="header_money">
				<div class="acc_summ"><span>$</span> <span class="header_balance">0</span></div>
				<div class="acc_pay"><a href=""><img src="{% static 'img/ico_wallet.svg' %}"></a></div>
				<div class="hd_line onmob"></div>
				<div class="acc_img onmob"><img src="{% static 'img/acc_img.png' %}"></div>
			</div>
			<div class="header_acc">
				<div class="acc_img"><img src="{% static 'img/acc_img.png' %}"></div>
				<span class="acc_name">@user</span>
				<a href="#" class="acc_logout" id="header-logout"><img src="{% static 'img/ico_logout.svg' %}"></a>
			</div>
			<div class="mob_bt"><img src="{% static 'img/ico_mobmenu.svg' %}"></div>
		</div>
		<!-- Мобильное меню -->
		<div class="mobile_menu_toggle" id="mobile-menu-toggle">
			<span></span>
			<span></span>
			<span></span>
		</div>
	</header>
	
	<!-- Мобильное меню -->
	<div class="mobile_menu" id="mobile-menu">
		<div class="mobile_menu_header">
			<a href="/" class="mobile_logo"><img src="{% static 'img/logo.svg' %}"> Gametrim</a>
			<button class="mobile_menu_close" id="mobile-menu-close">&times;</button>
		</div>
		<nav class="mobile_nav">
			<a href="/" class="mobile_nav_item">Homepage</a>
			<a href="{% url 'answers' %}" class="mobile_nav_item">Question & Answer</a>
			<a href="{% url 'account' %}" class="mobile_nav_item">Account</a>
			<a href="{% url 'logout' %}" class="mobile_nav_item mobile_logout">Logout</a>
		</nav>
		<!-- Мобильный баланс -->
		<div class="mobile_balance">
			<div class="mobile_balance_header">
				<span>Balance</span>
				<div class="mobile_balance_amount">
					<span>$</span> <span class="mobile_header_balance">0</span>
				</div>
			</div>
			<a href="#" class="mobile_deposit_btn">
				<img src="{% static 'img/ico_wallet.svg' %}"> Deposit
			</a>
		</div>
	</div>
	
	<div class="page">
		<div class="acc_block contain">
			<div class="acc_left">
				<div class="acc_info">
					<div class="acc_info_data">
						<div class="acc_info_img"><img src="{% static 'img/acc_avatar.png' %}"></div>
						<div class="acc_info_pers">
							<p class="pers_name">User</p>
							<p class="pers_nick">Your Fortnite Nickname: <span class="user_nickname">Not set</span> <a id="change_nick" href="#"><img src="{% static 'img/ico_pencil.svg' %}"></a></p>
							<p class="pers_regdate">Registration date: <span class="user_regdate">Loading...</span></p>
						</div>
					</div>
					<a href="/" class="acc_info_logout"><img src="{% static 'img/ico_info_out.svg' %}"></a>
				</div>
				<div class="acc_profav">
					<div class="acc_profav_left">
						<div class="acc_profav_img"><img src="{% static 'img/empty_avatar.svg' %}"></div>
						<p>Install profile avatar</p>
					</div>
					<a href="#" class="acc_avatar_load"><img src="{% static 'img/ico_upload.svg' %}"> Download</a>
				</div>
			</div>
			<div class="acc_right">
				<div class="balance_block">
					<div class="balance_row">
						<div class="balance_val">
							<div class="balance_val_rev">
								<div class="balance_wal"><img src="{% static 'img/ico_wallet_wh.svg' %}"></div>
								<div class="balance_wal_num"><span>Balance</span><p class="balance_money">0 $</p></div>
							</div>
						</div>
						<a href="#" class="bt_deposit"><img src="{% static 'img/ico_deposit.svg' %}">Deposit</a>
					</div>
				</div>
				<div class="withdr_hist">
					<div class="wh_rval">
						<div class="wh_row">
							<img src="{% static 'img/ico_withdr.svg' %}"> <p><a href="#">Withdrawal history</a></p> <span class="wh_num">0</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="skin_block wh">
			<div class="contain">
				<div class="wh_skin">
					<div class="case_list">
						<!-- Skins will be loaded dynamically via JavaScript -->
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="bg"></div>
	<div class="chgname_popup popup_block" style="display: none;">
		<p>Change your nickname in Fortnite</p>
		<div class="chgname_inprow">
			<input type="text" class="drop_data_inp" name="new_name" placeholder="Enter new nickname"> <span><img src="{% static 'img/ico_check.svg' %}"></span>
		</div>
		<a href="#" class="drop_mid_confirm">Confirm</a>
	</div>

<script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
<script src="{% static 'js/account.js' %}"></script>

<script>
// Обновление баланса для мобильного меню
async function refreshMobileBalance() {
	try {
		const res = await fetch('/accounts/account-info/', { credentials: 'same-origin' });
		if (!res.ok) return;
		const data = await res.json();
		if (!data || !data.success || !data.user) return;
		const user = data.user;
		
		// Обновляем основной баланс
		var bal = document.querySelector('.header_balance');
		if (bal && user.balance != null) bal.textContent = user.balance;
		
		// Обновляем мобильный баланс
		var mobileBal = document.querySelector('.mobile_header_balance');
		if (mobileBal && user.balance != null) mobileBal.textContent = user.balance;
		
		// Обновляем баланс в правом блоке
		var balanceMoney = document.querySelector('.balance_money');
		if (balanceMoney && user.balance != null) balanceMoney.textContent = user.balance + ' $';
		
		var nameEl = document.querySelector('.acc_name');
		if (nameEl) {
			var nick = user.nick_in_game || user.username || user.email || '@user';
			nameEl.textContent = nick;
		}
		
		if (user.avatar) {
			var imgs = document.querySelectorAll('.acc_img img');
			imgs.forEach(function(img){ img.src = user.avatar; });
		}
	} catch (e) {
		console.error('Error refreshing balance:', e);
	}
}

// Обработчик для logout в хедере
document.addEventListener('DOMContentLoaded', function() {
	document.getElementById('header-logout').addEventListener('click', function(e) {
		e.preventDefault();
		
		// Очищаем localStorage
		localStorage.removeItem('authToken');
		localStorage.removeItem('userData');
		
		// Мгновенно перенаправляем на главную страницу
		window.location.href = '/';
		
		// В фоне выполняем logout через API (без ожидания)
		fetch('/accounts/logout/', {
			method: 'GET',
			credentials: 'same-origin'
		}).catch(function(error) {
			console.error('Logout API error:', error);
		});
	});
	
	// Обработчик для logout в мобильном меню
	document.querySelector('.mobile_logout').addEventListener('click', function(e) {
		e.preventDefault();
		
		// Закрываем мобильное меню
		document.getElementById('mobile-menu').classList.remove('active');
		document.getElementById('mobile-menu-toggle').classList.remove('active');
		document.body.classList.remove('menu-open');
		
		// Очищаем localStorage
		localStorage.removeItem('authToken');
		localStorage.removeItem('userData');
		
		// Мгновенно перенаправляем на главную страницу
		window.location.href = '/';
		
		// В фоне выполняем logout через API (без ожидания)
		fetch('/accounts/logout/', {
			method: 'GET',
			credentials: 'same-origin'
		}).catch(function(error) {
			console.error('Logout API error:', error);
		});
	});
});

// Обновляем баланс при загрузке страницы
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', refreshMobileBalance);
} else {
	refreshMobileBalance();
}
</script>

</body>
</html>