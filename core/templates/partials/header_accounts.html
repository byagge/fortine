{% load static %}
<header class="contain">
	<div class="header_left">
		<a href="/" class="logo"><img src="{% static 'img/logo.png' %}"></a>
		<a href="/" class="menu_item">Homepage</a>
		<a href="{% url 'answers' %}" class="menu_item">Question & Answer</a>
	</div>
	<div class="header_right">
		<div class="header_money">
			<div class="acc_summ"><span>$</span> <span class="header_balance">0</span></div>
			<div class="acc_pay"><a href="{% url 'finances:deposit' %}"><img src="{% static 'img/ico_wallet.svg' %}"></a></div>
			<div class="hd_line onmob"></div>
			<div class="acc_img onmob"><img src="{% static 'img/acc_img.png' %}"></div>
		</div>
		<div class="header_acc">
			<div class="acc_img"><img src="{% static 'img/acc_img.png' %}"></div>
			 <a href="{% url 'account' %}"><span class="acc_name">@user</span></a>
			<a href="/logout/" class="acc_logout" id="header-logout"><img src="{% static 'img/ico_logout.svg' %}"></a>
		</div>
		<div class="mob_bt"><img src="{% static 'img/ico_mobmenu.svg' %}"></div>
	</div>
	<!-- Мобильное меню -->
	<div class="mobile_menu_toggle" id="mobile-menu-toggle">
		<span></span>
		<span></span>
		<span></span>
	</div>
</header> 

<!-- Мобильное меню -->
<div class="mobile_menu" id="mobile-menu">
	<div class="mobile_menu_header">
		<a href="/" class="mobile_logo"><img src="{% static 'img/logo.svg' %}"> Gametrim</a>
		<button class="mobile_menu_close" id="mobile-menu-close">&times;</button>
	</div>
	<nav class="mobile_nav">
		<a href="/" class="mobile_nav_item">Homepage</a>
		<a href="{% url 'answers' %}" class="mobile_nav_item">Question & Answer</a>
		<a href="{% url 'account' %}" class="mobile_nav_item">Account</a>
		<a href="{% url 'finances:deposit' %}" class="mobile_nav_item">Deposit</a>
		<a href="{% url 'finances:history' %}" class="mobile_nav_item">History</a>
	</nav>
	<!-- Мобильный баланс -->
	<div class="mobile_balance">
		<div class="mobile_balance_header">
			<span>Balance</span>
			<div class="mobile_balance_amount">
				<span>$</span> <span class="mobile_header_balance">0</span>
			</div>
		</div>
		<a href="{% url 'finances:deposit' %}" class="mobile_deposit_btn">
			<img src="{% static 'img/ico_wallet.svg' %}"> Deposit
		</a>
	</div>
</div>

<script>
(function(){
	async function refreshHeader() {
		try {
			const res = await fetch('/accounts/account-info/', { credentials: 'same-origin' });
			if (!res.ok) return;
			const data = await res.json();
			if (!data || !data.success || !data.user) return;
			const user = data.user;
			
			// Обновляем основной баланс
			var bal = document.querySelector('.header_balance');
			if (bal && user.balance != null) bal.textContent = user.balance;
			
			// Обновляем мобильный баланс
			var mobileBal = document.querySelector('.mobile_header_balance');
			if (mobileBal && user.balance != null) mobileBal.textContent = user.balance;
			
			var nameEl = document.querySelector('.acc_name');
			if (nameEl) {
				var nick = user.nick_in_game || user.username || user.email || '@user';
				nameEl.textContent = nick;
			}
			if (user.avatar) {
				var imgs = document.querySelectorAll('.acc_img img');
				imgs.forEach(function(img){ img.src = user.avatar; });
			}
		} catch (e) {
			// silent
		}
	}
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', refreshHeader);
	} else {
		refreshHeader();
	}
	
	// Обработка logout в хедере
	document.getElementById('header-logout').addEventListener('click', function(e) {
		e.preventDefault();
		
		// Очищаем localStorage
		localStorage.removeItem('authToken');
		localStorage.removeItem('userData');
		
		// Мгновенно перенаправляем на главную страницу
		window.location.href = '/';
		
		// В фоне выполняем logout через API (без ожидания)
		fetch('/accounts/logout/', {
			method: 'GET',
			credentials: 'same-origin'
		}).catch(function(error) {
			console.error('Logout API error:', error);
		});
	});
})();
</script> 